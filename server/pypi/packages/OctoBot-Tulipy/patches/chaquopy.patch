--- src-original/setup.py	2024-01-01 00:00:00.000000000 +0000
+++ src/setup.py	2024-01-01 00:00:00.000000000 +0000
@@ -1,5 +1,12 @@
+import os
 from setuptools import setup, find_packages
 from distutils.extension import Extension
 
+# Chaquopy: Cython-generated code needs -fPIC for shared libraries on Android.
+# Without this, we get linker errors like "relocation R_AARCH64_ADR_PREL_PG_HI21
+# cannot be used against symbol; recompile with -fPIC"
+if "CFLAGS" in os.environ and "-fPIC" not in os.environ["CFLAGS"]:
+    os.environ["CFLAGS"] += " -fPIC"
+
 import numpy as np
 from Cython.Distutils import build_ext
 
